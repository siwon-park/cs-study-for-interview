# 00_NAT

> Network Address Translation; 네트워크 주소 변환

NAT의 결론은 `출발지 혹은 목적지의 IP 주소를 바꾸겠다는 것을 의미`한다.

## 1. 등장 배경

NAT의 등장 역시 사설망과 관련이 깊다.

### 1) 사설망

사설 IP는 소속된 내부 네트워크에서만 사용이 가능하다. 따라서 사설 IP를 가지고 외부망인 공인망에서는 통신이 불가능하다. 따라서 자신의 출발지 IP(Source IP)를 사설 IP에서 사용하는 숫자와 형태 그대로 사용할 수 없다.

만약 자신의 출발지 IP를 사설 IP로 유지한 채 공인망으로 나간다해도 자신의 출발지로 돌아오는 것은 불가능하다. 왜냐하면 자신과 같은 숫자의 사설 IP를 가지고 있는 디바이스는 매우 많기 때문이다.

그러다면 사설망에 있는 디바이스가 외부와 통신을 하고자할 때는 어떻게 할까?

### 2) 사설 IP를 공인 IP로

이에 사설 IP를 공인 IP로 변환할 필요가 생겼고, 이를 위한 방법이 NAT(Network Address Translation), 네트워크 주소 변환이라는 기술이다.

<br>

## 2. 정의

NAT는 IP 패킷의 TCP/UDP 포트 숫자와 출발지 및 목적지의 IP 주소 등을 재기록하면서 라우터를 통해 네트워크 트래픽을 주고받는 기술을 말한다.

보통 `공유기(라우터)`가 이 역할(기능)을 수행한다.

이를 다시 해석해보면 다음과 같다.

- 사설망 → 공인망 통신 시, 사설 IP → 공인 IP 변환
- 공인망 → 사설망 통신 시, 올바른 출발지의 사설 IP로 변환
- 포트 변환
  - 흔히, IP주소만 변환한다고 알고있을 수도 있지만 엄밀히 말해 포트까지 변환한다.
  - 그래서 Port Address Translation; PAT 혹은 NPAT라고도 한다.

### 1) 예시

사용자 1이 외부의 서버에 접근하려는 상황

![image](https://github.com/siwon-park/cs-study-for-interview/assets/93081720/8b9c9591-0dd4-4d0d-a7d6-b86edb604bce)

그러면 자신의 사설 IP인 (10.10.10.10/24)를 공인 IP로 변환하여 통신을 해야 한다. 그 과정은 다음과 같이 이루어진다.

![image](https://github.com/siwon-park/cs-study-for-interview/assets/93081720/3a0a672a-40e1-44ca-b649-e3d10f9dc381)

1. 사용자 1이 외부와의 통신을 위해 NAT 장비에 접근한다.
2. NAT장비는 자신에게 허용된 규칙을 확인하여 사용자 1의 사설 IP를 자신의 공인 IP로 변환하여 웹 서버에 전달한다.
3. 웹 서버는 사용자가 보낸 요청을 받아 응답하여 보냄 (공유기의 공인 IP를 목적지로 하여 전달)
4. 응답 패킷을 받은 NAT 장비는 과거 사용자가 보낸 요청에 대한 응답임을 기억(Stateful)하여, 목적지 IP를 자신의 공인 IP에서 사용자 1의 사설 IP로 변환하여 전달한다.

<br>

### 2) 예시2

위의 예시에서는 사용자 1 한 명이 출발지 포트를 9999로 설정하여 외부와 통신을 하였다.

그런데 만약에 동시에 사용자 2도 자신의 출발지 포트를 9999로 설정하여 전송한다면 어떻게 될까?

나갈 때는 상관이 없겠지만 문제는 돌아올 때 이 응답을 사용자 1로 보내야할 지, 사용자 2로 보내야 할 지 모른다는 것이다.

나갈 때 사용할 수 있는 공인 IP는 공유기의 공인 IP 한 개뿐이니, 그렇다면 바꿀 수 있는 것 중에 남은 것은 `포트`뿐이다.

이것이 바로 `PAT(Port Address Translation)`이다. `NAT 장비가 출발지 포트를 임의로 변경`하는 것이다.

![image](https://github.com/siwon-park/cs-study-for-interview/assets/93081720/4e1fa75c-2d1a-4f05-96a7-8272be42881e)

이제 포트 9999면 사용자 1, 포트 10000이면 사용자 2로 구분할 수 있게 되었다.

<br>

### 3) Stateful, Session Table

NAT 장비 역할을 하는 네트워크 디바이스의 종류는 매우 다양하다.

- 가정의 경우 `공유기`가 NAT 역할을 주로 하며,
- 기업의 경우 과거에는 `라우터`, 현재는 `방화벽, VPN, L4 스위치` 등이 NAT 역할을 수행하고 있다.

NAT를 수행하는 장비들은 자신에게 설정된 규칙에 따라 허용/거부를 판단하고 NAT를 실시하여 이를 기록해둔다. 이러한 특성을 `Stateful`이라고 한다.

이러한 역할을 수행하는 장비를 `Session 장비`라고 부르며, NAT를 수행한 내역을 기록한 테이블을 `Session Table`이라고 한다.

- 세션 테이블의 예시

![image](https://github.com/siwon-park/cs-study-for-interview/assets/93081720/0b39293a-718a-4b93-be76-ee9defee0855)

보통 세션 장비에 정해진 규칙에 의해 허용된 IP만이 NAT를 실시하여 세션 테이블에 세션 정보를 올릴 수 있다.